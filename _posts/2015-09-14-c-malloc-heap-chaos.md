---
title: C语言malloc遭遇内存混乱
category: 
    - technique
layout: post
---

前些时日要在安卓与iOS平台上实现一个类似GIF的动态图片格式的解析与生成。
为了不用写两份代码，而且感觉逻辑结构不复杂，果断选择使用C语言，连C++都不想用。
标准C语言依然是那么干净纯洁，虽然相比较于C++缺乏一些强大的特性，但是它结构简单，
只具备必要的特性，就像写Lua代码一样让人感觉一切都在掌握中，这种感觉很好。
然而美妙的世界很快就打破了，尽管我很谨慎又巧妙地对待指针，没有一丝的泄露，
但是最终我遭遇了malloc地狱，它由快变慢，直到最后在经过漫长的沉默后给我了NULL。

事情详细点的经过是这样的，众所周知在C/C++中堆内存的使用是需要非常谨慎的，
过早的释放、不释放以及多次释放都会导致不可预知的严重错误，也是基于这个理由，
大部分开发者对这基础语言敬而远之，新的编程语言也都隐藏了内存管理与指针的概念。
但是对于一些图形处理算法来说，能直接访问内存实现起来会比较方便，
并且想要尽量不重写代码跨越iOS与安卓，C/C++也是不可避免。
逃不掉要与指针打交道，于是我仿照早期Objective-C早期手动计数的设计，
制作了一个我自己的简单带计数指针管理框架（在本文最后附上代码）。
