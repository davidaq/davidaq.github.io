<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf=8">
    <meta name="viewport" content="initial-scale=1, minimum-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no">
    <title>五子棋AI</title>
    <style>
      body {
        break-word: break-all;
      }
    </style>
  </head>
  <body>
    <div id="gameboard"></div>
    <script src="game.js"></script>
    <script src="player-ai.js"></script>
    <script src="player-ui.js"></script>
    <script>
      const HORDE_SIZE = 16;
      let horde = [];
      try {
        horde.push({
          core: JSON.parse(localStorage.goBangCore),
        });
      } catch (err) {}
      horde.push({
        core: createRandomCore(),
      });
      const ui = new PlayerUI(document.getElementById('gameboard'));
      (async () => {
        let epoch = 0;
        let maxRounds = 20;
        while (true) {
          await new Promise(r => setTimeout(r, 5));
          while (horde.length < HORDE_SIZE) {
            const pa = Math.floor(Math.random() * horde.length);
            const pb = Math.floor(Math.random() * horde.length);
            horde.push({
              //core: inheritCore(crossCore(horde[pa].core, horde[pb].core)),
              core: inheritCore(horde[pa].core),
            });
          }
          horde.forEach(orc => {
            orc.survive = true;
          });
          const index = horde.map((v, i) => i);
          const vs = [];
          while (index.length > 1) {
            const a = index.splice(Math.floor(Math.random() * index.length), 1)[0];
            const b = index.splice(Math.floor(Math.random() * index.length), 1)[0];
            vs.push([a, b]);
          }
          let lastGame = null;
          const play = (black, white) => {
            const game = new Game([black, white]);
            game.remainRound = Math.min(game.remainRound, maxRounds);
            game.onEnd = (result) => {
              if (result === TIE) {
                black.score += 1;
                white.score += 1;
                lastGame = game;
              } else if (result === BLACK) {
                black.score += 2;
              } else {
                white.score += 2;
              }
            };
            game.play();
          };
          for (let i = 0; i < vs.length; i++) {
            const [a, b] = vs[i];
            const pa = new PlayerAI(horde[a].core);
            // const pb = new PlayerAI(horde[b].core);
            const pb = {
              decide (game, callback) {
                for (let y = 0; y < BOARD_SIZE; y++) {
                  for (let x = 0; x < BOARD_SIZE; x++) {
                    if (game.board[y][x] === EMPTY) {
                      callback(x, y);
                      return
                    }
                  }
                }
              },
              end () {}
            }
            pa.score = 0;
            pb.score = 0;
            play(pa, pb);
            await new Promise(r => setTimeout(r, 5));
            play(pb, pa);
            await new Promise(r => setTimeout(r, 5));
            horde[a].survive = pa.score > 0;
            // horde[b].survive = pb.score > 2;
          }
          
          epoch++;
          lastGame && ui.end(lastGame);
          console.log('epoch', epoch, horde.map(v => v.survive), maxRounds);
          const remain = horde.filter(orc => orc.survive);
          if (remain.length < 2) {
            maxRounds += 20;
          } else if (maxRounds > 10) {
            maxRounds -= 5;
            horde = remain;
          }
          localStorage.goBangCore = JSON.stringify(horde[0].core);
        }
      })();
    </script>
  </body>
</html>

